@model List<Titulacion.Models.Profesor>

@{
    // Usamos el layout que ya tenías definido
    Layout = "~/Views/Shared/_LayaoutAlumno.cshtml";
    ViewData["Title"] = "Inicio Alumno";
}

<h1>Bienvenido @ViewBag.Nombre</h1>

@if (!(bool)ViewBag.Tutoria)
{
    <h4>Profesores Disponibles</h4>
    <table class="table table-striped table-hover">
        <thead class="thead-pantone">
            <tr>
                <th>Profesor</th>
                <th>Horas de Tutoría Disponibles</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@($"{item.Nombre} {item.ApellidoPat} {item.ApellidoMat}")</td>
                    <td>@item.HorasTutoria</td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" class="btn btn-primary mt-4" data-bs-toggle="modal" data-bs-target="#solicitarTutoriaModal">
        Solicitar Tutoría
    </button>
}
else
{
    <div class="alert alert-success" role="alert">
        ¡Felicidades! Ya tienes una tutoría inscrita.
    </div>
    <a asp-action="Comprobante" asp-controller="Sesiones" class="btn btn-secondary">Generar Comprobante</a>
}

<div class="modal fade" id="solicitarTutoriaModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Solicitud de Tutoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="boletaInput" class="form-label">Boleta:</label>
                    <input type="text" class="form-control" id="boletaInput" value="@ViewBag.Boleta" readonly>
                </div>
                <div class="mb-3">
                    <label for="nombreInput" class="form-label">Nombre:</label>
                    <input type="text" class="form-control" id="nombreInput" value="@ViewBag.Nombre" readonly>
                </div>
                <div class="mb-3">
                    <label for="profesorSelect" class="form-label">Selecciona tu profesor:</label>
                    <select class="form-select" id="profesorSelect" required>
                        <option value="">-- Elige un profesor --</option>
                        @foreach (var item in Model)
                        {
                            <option value="@($"{item.Nombre} {item.ApellidoPat} {item.ApellidoMat}")">@($"{item.Nombre} {item.ApellidoPat} {item.ApellidoMat}")</option>
                        }
                    </select>
                </div>
                <div id="mensajeModal" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnEnviarSolicitud">Solicitar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Este código se ejecuta cuando la página ha cargado completamente
        $(document).ready(function () {

            // Se activa cuando se hace clic en el botón "Solicitar" del modal
            $("#btnEnviarSolicitud").click(function () {

                var profesorSeleccionado = $("#profesorSelect").val();

                // Validación simple para asegurar que se eligió un profesor
                if (!profesorSeleccionado) {
                    $("#mensajeModal").html('<div class="alert alert-warning">Por favor, selecciona un profesor.</div>');
                    return; // Detiene la ejecución si no se seleccionó nada
                }

                // 1. Obtenemos los datos del formulario del modal
                var solicitudData = {
                    Boleta: $("#boletaInput").val(),
                    Profesor: profesorSeleccionado
                };

                // 2. Hacemos una llamada AJAX al método del controlador
                $.ajax({
                    url: '@Url.Action("SolicitarTutoria", "Sesiones")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(solicitudData),
                    success: function (response) {
                        // 3. Se ejecuta si la solicitud fue exitosa
                        if (response.success) {
                            alert(response.message); // Muestra un popup de éxito
                            window.location.reload(); // Recarga la página para mostrar el nuevo estado
                        } else {
                            // Muestra el mensaje de error que nos envió el controlador
                            $("#mensajeModal").html('<div class="alert alert-danger">' + response.message + '</div>');
                        }
                    },
                    error: function () {
                        // 4. Se ejecuta si hubo un error de conexión
                        $("#mensajeModal").html('<div class="alert alert-danger">Error al conectar con el servidor.</div>');
                    }
                });
            });
        });
    </script>
}